"""
Enhanced Kavak Knowledge Setup
Configura la base de conocimiento completa con scraping y contenido de respaldo
"""
import asyncio
import json
import os
import logging
from typing import Dict, List

# Configure logging
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

def create_comprehensive_kavak_knowledge() -> List[Dict]:
    """
    Create comprehensive Kavak knowledge base
    Combines scraping attempts with rich fallback content
    """
    logger.info("üèóÔ∏è Creating comprehensive Kavak knowledge base...")
    
    # Enhanced knowledge base with detailed information
    comprehensive_content = [
        {
            'url': 'https://www.kavak.com/mx/blog/sedes-de-kavak-en-mexico',
            'title': 'Sedes de Kavak en M√©xico',
            'main_content': '''
            Kavak cuenta con presencia en las principales ciudades de M√©xico, 
            ofreciendo un servicio completo de compra y venta de autos seminuevos. 
            Nuestras ubicaciones estrat√©gicas permiten brindar cobertura nacional 
            con el respaldo de la tecnolog√≠a m√°s avanzada del sector automotriz.
            ''',
            'headings': [
                'Ubicaciones Kavak en M√©xico',
                'Ciudad de M√©xico',
                'Guadalajara, Jalisco', 
                'Monterrey, Nuevo Le√≥n',
                'Puebla, Puebla',
                'Tijuana, Baja California',
                'M√©rida, Yucat√°n'
            ],
            'paragraphs': [
                'Kavak revoluciona la experiencia de compra de autos seminuevos en M√©xico.',
                'Ciudad de M√©xico: M√∫ltiples ubicaciones estrat√©gicas para mayor conveniencia.',
                'Guadalajara: Servicio completo en la Perla de Occidente.',
                'Monterrey: Presencia s√≥lida en el norte del pa√≠s.',
                'Entrega a domicilio disponible en todas las ciudades.',
                'Pruebas de manejo programadas seg√∫n conveniencia del cliente.',
                'Red de talleres autorizados para servicio postventa.'
            ],
            'lists': [
                'Entrega a domicilio disponible',
                'Prueba de manejo a domicilio',
                'Financiamiento en sitio',
                'Proceso 100% digital',
                'Servicio de intercambio',
                'Garant√≠a extendida disponible'
            ],
            'metadata': {
                'description': 'Ubicaciones y sedes de Kavak en las principales ciudades de M√©xico',
                'category': 'locations'
            }
        },
        {
            'url': 'kavak://propuesta-valor',
            'title': 'Propuesta de Valor Kavak - L√≠der en Autos Seminuevos',
            'main_content': '''
            Kavak es la plataforma l√≠der de autos seminuevos en M√©xico y Latinoam√©rica. 
            Ofrecemos una experiencia de compra revolucionaria con garant√≠a real, 
            financiamiento accesible y un proceso completamente digital. 
            M√°s de 1 mill√≥n de mexicanos han confiado en nosotros para encontrar su auto ideal.
            ''',
            'headings': [
                'Por qu√© elegir Kavak',
                'Garant√≠a real de 3 meses',
                'Financiamiento hasta 84 meses',
                'Proceso 100% digital',
                'Inspecci√≥n de 240 puntos',
                'L√≠deres en innovaci√≥n'
            ],
            'paragraphs': [
                'Somos la √∫nica plataforma que ofrece garant√≠a real en autos seminuevos.',
                'Inspecci√≥n rigurosa de 240 puntos garantiza la calidad de cada veh√≠culo.',
                'Financiamiento flexible desde 12 hasta 84 meses con tasas competitivas.',
                'Proceso completamente digital: desde la b√∫squeda hasta la entrega.',
                'Red nacional de servicio postventa y talleres autorizados.',
                'Intercambio garantizado si el auto no cumple expectativas.',
                'M√°s de 1 mill√≥n de clientes satisfechos en toda Latinoam√©rica.'
            ],
            'lists': [
                'Garant√≠a de 3 meses o 3,000 km',
                'Inspecci√≥n de 240 puntos',
                'Financiamiento hasta 84 meses',
                'Proceso 100% digital',
                'Entrega a domicilio',
                'Intercambio garantizado',
                'Servicio postventa especializado'
            ],
            'metadata': {
                'description': 'Propuesta de valor y ventajas de elegir Kavak',
                'category': 'value_proposition'
            }
        },
        {
            'url': 'kavak://garantia-cobertura',
            'title': 'Garant√≠a Kavak - Cobertura Completa',
            'main_content': '''
            La garant√≠a Kavak es √∫nica en el mercado de autos seminuevos. 
            Cubrimos 3 meses o 3,000 kil√≥metros con cobertura completa de 
            componentes mec√°nicos principales. Somos la √∫nica plataforma 
            que respalda la calidad de sus veh√≠culos con garant√≠a real.
            ''',
            'headings': [
                'Garant√≠a de 3 meses o 3,000 km',
                'Cobertura completa',
                '√önicos en el mercado',
                'Red de talleres autorizados'
            ],
            'paragraphs': [
                'Cobertura de motor, transmisi√≥n, sistema el√©ctrico y frenos.',
                'Aire acondicionado y sistemas de seguridad incluidos.',
                'Red nacional de talleres autorizados para reparaciones.',
                'Proceso de reclamaci√≥n simple y r√°pido.',
                'Sin letra peque√±a ni exclusiones sorpresa.',
                'Garant√≠a transferible al nuevo propietario.',
                'Somos los √∫nicos que realmente garantizamos la calidad.'
            ],
            'lists': [
                'Motor y transmisi√≥n',
                'Sistema el√©ctrico completo',
                'Frenos y suspensi√≥n',
                'Aire acondicionado',
                'Sistemas de seguridad',
                'Direcci√≥n hidr√°ulica',
                'Sistema de enfriamiento'
            ],
            'metadata': {
                'description': 'Detalles completos de la garant√≠a Kavak',
                'category': 'warranty'
            }
        },
        {
            'url': 'kavak://financiamiento-opciones',
            'title': 'Financiamiento Kavak - Opciones Flexibles',
            'main_content': '''
            Ofrecemos las mejores opciones de financiamiento del mercado 
            con tasas competitivas desde 10% anual. Plazos flexibles de 
            12 hasta 84 meses, aprobaci√≥n r√°pida en 24 horas y sin 
            requisitos complicados. Tu auto ideal al alcance de tu presupuesto.
            ''',
            'headings': [
                'Financiamiento desde 10% anual',
                'Plazos de 12 a 84 meses',
                'Aprobaci√≥n en 24 horas',
                'Sin aval requerido'
            ],
            'paragraphs': [
                'Tasas de inter√©s competitivas desde 10% anual fijo.',
                'Plazos flexibles adaptados a tu capacidad de pago.',
                'Aprobaci√≥n r√°pida con m√≠nimos requisitos.',
                'Sin aval, sin garant√≠as adicionales complicadas.',
                'Pago anticipado sin penalizaciones.',
                'Calculadora en l√≠nea para simular tu plan.',
                'Asesor√≠a personalizada para encontrar la mejor opci√≥n.'
            ],
            'lists': [
                'Tasa desde 10% anual',
                'Plazos: 12, 24, 36, 48, 60, 72, 84 meses',
                'Aprobaci√≥n en 24 horas',
                'Sin aval requerido',
                'Pago anticipado sin penalizaci√≥n',
                'Proceso 100% digital',
                'Asesor√≠a personalizada'
            ],
            'metadata': {
                'description': 'Opciones de financiamiento y cr√©dito automotriz',
                'category': 'financing'
            }
        },
        {
            'url': 'kavak://proceso-compra',
            'title': 'Proceso de Compra Kavak - Simple y Digital',
            'main_content': '''
            Comprar tu auto en Kavak es simple, r√°pido y 100% digital. 
            Desde la b√∫squeda hasta la entrega, todo el proceso est√° 
            dise√±ado para ofrecerte la mejor experiencia. Sin filas, 
            sin papeleo complicado, sin p√©rdida de tiempo.
            ''',
            'headings': [
                'Proceso 100% digital',
                'B√∫squeda inteligente',
                'Prueba de manejo',
                'Financiamiento express',
                'Entrega a domicilio'
            ],
            'paragraphs': [
                'Busca y filtra entre miles de autos verificados.',
                'Agenda tu prueba de manejo en l√≠nea.',
                'Solicita financiamiento con aprobaci√≥n r√°pida.',
                'Completa la compra desde tu celular.',
                'Recibe tu auto en casa o en sucursal.',
                'Documentos y placas incluidos en el servicio.',
                'Soporte completo durante todo el proceso.'
            ],
            'lists': [
                'Buscar auto ideal',
                'Agendar prueba de manejo',
                'Solicitar financiamiento',
                'Completar compra digital',
                'Recibir auto con documentos',
                'Activar garant√≠a autom√°ticamente'
            ],
            'metadata': {
                'description': 'Paso a paso del proceso de compra en Kavak',
                'category': 'process'
            }
        }
    ]
    
    logger.info(f"‚úÖ Created comprehensive knowledge base with {len(comprehensive_content)} detailed entries")
    return comprehensive_content

def setup_kavak_knowledge_base():
    """
    Complete setup of Kavak knowledge base
    Configura completamente la base de conocimiento
    """
    logger.info("üöÄ Setting up Kavak Knowledge Base...")
    
    # Ensure data directory exists
    os.makedirs('data', exist_ok=True)
    
    try:
        # Try to run the scraper first
        logger.info("üåê Attempting to scrape live Kavak content...")
        
        # Import and run scraper
        import sys
        sys.path.append('scripts')
        
        try:
            from scrape_kavak import KavakWebScraper
            
            scraper = KavakWebScraper()
            scraped_content = scraper.scrape_kavak_knowledge()
            
            if len(scraped_content) >= 2:
                logger.info(f"‚úÖ Successfully scraped {len(scraped_content)} pages")
                # Save scraped content
                with open('data/kavak_knowledge.json', 'w', encoding='utf-8') as f:
                    json.dump(scraped_content, f, ensure_ascii=False, indent=2)
                
            else:
                raise Exception("Insufficient content scraped")
                
        except Exception as scraping_error:
            logger.warning(f"‚ö†Ô∏è Scraping failed: {scraping_error}")
            raise scraping_error
            
    except Exception as e:
        # Fallback to comprehensive content
        logger.info("üîÑ Using comprehensive fallback content...")
        
        comprehensive_content = create_comprehensive_kavak_knowledge()
        
        # Save comprehensive content
        with open('data/kavak_knowledge.json', 'w', encoding='utf-8') as f:
            json.dump(comprehensive_content, f, ensure_ascii=False, indent=2)
        
        logger.info("üíæ Comprehensive Kavak knowledge base saved")
    
    # Verify the knowledge base
    try:
        with open('data/kavak_knowledge.json', 'r', encoding='utf-8') as f:
            content = json.load(f)
        
        logger.info(f"‚úÖ Knowledge base verified: {len(content)} entries loaded")
        
        # Print summary
        print("\nüìö KAVAK KNOWLEDGE BASE SUMMARY:")
        print("=" * 50)
        for item in content:
            title = item.get('title', 'Sin t√≠tulo')[:50]
            category = item.get('metadata', {}).get('category', 'general')
            content_length = len(item.get('main_content', ''))
            print(f"‚úÖ {title}")
            print(f"   Category: {category}")
            print(f"   Content: {content_length} characters")
            print()
        
        print("üéâ Kavak knowledge base ready for RAG!")
        
    except Exception as e:
        logger.error(f"‚ùå Error verifying knowledge base: {e}")

if __name__ == "__main__":
    setup_kavak_knowledge_base()
