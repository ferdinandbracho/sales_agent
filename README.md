# Kavak AI Sales Agent

An intelligent sales agent for Kavak Mexico that operates via WhatsApp, capable of recommending cars, calculating financing, and answering questions about Kavak's services.

## Technical Overview

This project is built using:

- **FastAPI**: High-performance web framework for building APIs
- **LangChain**: Framework for developing applications powered by language models
- **OpenAI GPT-4o**: Advanced language model for natural language understanding and generation
- **Twilio API**: For WhatsApp integration
- **Pandas**: For data manipulation and analysis
- **Docker**: Containerization for consistent development and deployment

## Disclaimer

⚠️ **Important**: This is an independent project and is not affiliated with, endorsed by, or connected to Kavak in any way. It's a demonstration project only.

## Features

- **Car Search**: Intelligent search by budget, brand, and preferences
- **Financing Calculator**: Payment plans with 10% annual rate (3-6 years)
- **Kavak Information**: Warranties, purchase process, and services
- **WhatsApp Integration**: Live chat via Twilio
- **Spanish Processing**: 100% Mexican Spanish agent
- **Conversational Memory**: Maintains context throughout the conversation

## Quick Start (5 minutes)

### Prerequisites
- Python 3.11+
- UV package manager
- OpenAI API key
- Twilio account (free sandbox)

### Quick Start Script

The project includes a `start.sh` script that will guide you through the setup process:

```bash
# Make the script executable (first time only)
chmod +x start.sh

# Run the script
./start.sh
```

This script will check for required dependencies and show you the next steps to configure and run the project.

### Installation

1. **Clone the repository**
```bash
git clone <repository-url>
cd commercial_agent
```

2. **Initial setup**
```bash
make setup
```

3. **Configure environment variables**
   Copy the example environment file and update it with your credentials:
   ```bash
   cp .env.example .env
   ```
   
   Then edit the `.env` file with your actual credentials. The file should contain the following variables:
   ```bash
   # API Keys
   OPENAI_API_KEY=your_openai_key_here
   TWILIO_ACCOUNT_SID=your_twilio_sid
   TWILIO_AUTH_TOKEN=your_twilio_token

   # Optional for local webhooks
   NGROK_AUTHTOKEN=your_ngrok_token
   ```

4. **Start the application (with Docker Compose)**

#### Option 1: Use Docker Compose (recommended)

You can launch all required services using Docker Compose. This includes FastAPI, Redis, ChromaDB, and (optionally) an ngrok instance to expose the WhatsApp webhook.

**Requirements:**
- Docker and Docker Compose installed
- A free ngrok account ([sign up here](https://dashboard.ngrok.com/signup))
    - After signing up, copy your authentication token from [here](https://dashboard.ngrok.com/get-started/your-authtoken)
    - Add your token to your `.env` file as: `NGROK_AUTHTOKEN=your_token_here`

**Mode 1: You already have a public ngrok URL (or use another tunnel)**

1. Start the main services (without ngrok):
   ```bash
   docker-compose up -d redis chromadb kavak-api
   ```
2. Expose your local API with your own tunnel (ngrok, Cloudflare Tunnel, etc.) and get the public URL.
3. Set up the webhook in Twilio (see below).

**Mode 2: Use the development profile to run ngrok automatically**

1. Start all services, including ngrok:
   ```bash
   docker-compose --profile dev up -d
   ```
2. Get the public URL generated by ngrok:
   ```bash
   docker-compose logs -f ngrok-url
   ```
   You will see something like:
   ```
   =========================================
      URL de ngrok para el webhook de Twilio:
      https://xxxx-xxxx-xxxx.ngrok-free.app/webhook/whatsapp
   =========================================
   ```
3. Copy that URL.

**Set up the webhook in Twilio Sandbox**
- Go to [Twilio Console WhatsApp Sandbox](https://console.twilio.com/us1/develop/sms/try-it-out/whatsapp-learn)
- In the **"When a message comes in"** field, paste the URL you copied (for example: `https://xxxx-xxxx-xxxx.ngrok-free.app/webhook/whatsapp`)
- Done! Messages sent to your sandbox number will be routed to the agent.

---

All set! The agent will be available at `http://localhost:8000` (local) and via WhatsApp through Twilio Sandbox.

## Usage and Demo

### Example Conversations

**Búsqueda de Auto:**
```
Usuario: Hola, estoy buscando un auto seminuevo
Agente: ¡Hola! Soy tu asesor de ventas de Kavak. ¿Cuál es tu presupuesto?
Usuario: Alrededor de $300,000 MXN
Agente: ¡Perfecto! Tengo 15 opciones que podrían interesarte en ese rango de precio...
```

**Cálculo de Financiamiento:**
```
Usuario: ¿Cuánto pagaría mensualmente por un auto de $280,000 MXN?
Agente: Plan de Financiamiento:
Precio: $280,000 MXN
Enganche (20%): $56,000 MXN
Pago mensual: $5,690 MXN (48 meses)
Tasa de interés: 10% anual
```

### Demo Commands
```bash
make demo         # Run demo scenarios
make test-tools   # Test individual tools
make logs         # View application logs
```

## Architecture

### Main Components
- **FastAPI**: Main API and webhook handling
- **LangChain**: Agent orchestration and tools
- **OpenAI GPT-4o**: Main language model
- **Pandas**: Car catalog processing
- **Twilio**: WhatsApp integration

### Data Flow
```
WhatsApp User → Twilio → FastAPI → AI Agent → Tools → Response → WhatsApp
```

### Agent Tools
1. **search_cars_by_budget**: Search by price range
2. **search_specific_car**: Search by specific make/model
3. **calculate_financing**: Monthly payment calculations
4. **kavak_information**: Company information
5. **schedule_appointment**: Appointment scheduling
6. **compare_with_competition**: Kavak advantages

## Data

The system uses `sample_caso_ai_engineer.csv` with 100 sample vehicles including:
- Make, model, year, version
- Price, mileage, dimensions
- Features (Bluetooth, CarPlay)

## Development

### Project Structure
```text
.
├── .github/              # GitHub workflows and templates
├── data/                  # Data files and datasets
│   └── sample_cars.csv    # Sample car inventory
├── docs/                  # Documentation
├── src/                   # Source code
│   ├── agent/             # AI agent implementation
│   │   ├── kavak_agent.py # Main agent class
│   │   └── prompts.py     # System prompts and templates
│   ├── models/            # Data models and schemas
│   ├── services/          # Business logic services
│   ├── tools/             # Agent tools
│   │   ├── car_search.py  # Car search functionality
│   │   ├── financing.py   # Payment calculations
│   │   └── kavak_info.py  # Company information
│   └── webhook/           # Webhook handlers
│       └── twilio.py      # Twilio integration
├── tests/                 # Test suite
├── .env.example           # Environment variables template
├── docker-compose.yml     # Docker Compose configuration
├── Dockerfile             # Docker configuration
├── Makefile               # Common tasks and commands
├── pyproject.toml         # Project dependencies and metadata
└── README.md              # This file
```

### Development Commands
```bash
make install-deps    # Install/update dependencies
make format         # Format code with Black
make lint           # Run code quality checks
make test           # Run tests
make clean          # Clean temporary files
```

### Adding New Features
1. Create new tool in `src/tools/`
2. Register tool with the agent
3. Add tests in `tests/`
4. Update documentation

## Testing

### Running Tests
```bash
make test           # Run all tests
make test-tools     # Test tools only
make demo           # Run demo scenarios
```

### WhatsApp Integration Testing
1. Configure Twilio webhook: `https://your-ngrok-url.ngrok.io/webhook/whatsapp`
2. Send message to Twilio sandbox number
3. Verify agent response

## Deployment

### Local Development
```bash
make dev  # Local server with auto-reload
```

### Docker
```bash
docker-compose --profile full up -d  # With Redis and ChromaDB
```

## WhatsApp Setup

### 1. Set Up Twilio Sandbox
1. Create account at [Twilio](https://console.twilio.com)
2. Go to Messaging → Try it out → Send a WhatsApp message
3. Send `join [sandbox-name]` to +1 415 523 8886

### 2. Configure Webhook
1. Start application: `make dev`
2. Get public URL with ngrok
3. In Twilio Console → WhatsApp Sandbox Settings
4. Webhook URL: `https://your-ngrok-url.ngrok.io/webhook/whatsapp`

### 3. Test Integration
Send a message to your Twilio sandbox number and verify the agent's response.

## Project Roadmap

### Phase 1: Core Infrastructure

- **Cloud Deployment**: Container orchestration with AWS ECS/Fargate for scalable container management
- **Database**: Integrate with PostgreSQL for connection pooling
- **Monitoring & Observability**:
  - Application monitoring with DataDog for metrics
  - Error tracking with Sentry for real-time error reporting
  - LLM-specific monitoring with LangSmith for prompt engineering and model performance
  - Custom metrics for tracking token usage and response quality
- **Security Layer**:
  - API Gateway with rate limiting and authentication
  - AWS Secrets Manager for secure credential management
  - VPC configuration for network isolation

### Phase 2: Performance & Scale

- **Caching Layer**: Implement Redis for frequent queries
- **API Optimization**: Add response compression and caching headers
- **Load Testing**: Identify and address performance bottlenecks
- **Auto-scaling**: Configure horizontal scaling for high availability

### Phase 3: Advanced Features

- **Analytics Dashboard**: User interaction metrics
- **A/B Testing**: Test different agent responses
- **Multi-language Support**: Expand beyond Spanish
- **CI/CD Pipeline**: Automated testing and deployment

## Evaluation Framework

### Code Quality

- **Testing**: Achieve >80% test coverage
- **Type Safety**: Implement MyPy for static type checking
- **Code Style**: Enforce consistent formatting with Ruff
- **Documentation**: Maintain up-to-date API and inline docs

### Performance

- **Response Time**: <500ms for 95% of requests
- **Error Rate**: <0.1% error rate in production
- **Uptime**: 99.9% availability target

### Security

- **Authentication**: Implement API key rotation
- **Data Protection**: Encrypt sensitive data at rest
- **Compliance**: Follow OWASP security guidelines

### Business Features
- CRM Integration
- Lead Scoring
- Appointment Scheduling
- Sales Analytics

## Contributing

### Development Process
1. Fork the repository
2. Create a feature branch
3. Make changes with tests
4. Submit a pull request

### Code Standards
- Python 3.11+ with type hints
- Follow PEP 8 conventions

## Support

For issues or questions:
- Create a GitHub issue
- Check API documentation in `/docs`

## License

MIT License - see LICENSE file for details

---